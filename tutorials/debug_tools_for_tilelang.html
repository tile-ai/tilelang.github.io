<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Auto-Tuning Techniques for Performance Optimization" href="auto_tuning.html" /><link rel="prev" title="Annotate Memory Layout" href="annotate_memory_layout.html" />

    <!-- Generated with Sphinx 5.2.3 and Furo 2023.03.27 -->
        <title>Debugging Tile Language Programs - Tile Language 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Tile Language <br> 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/img/logo-row.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/img/logo-row.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Tile Language <br> 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">GET STARTED</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../get_started/Installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/overview.html">The Tile Language: A Brief Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TUTORIALS</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="writing_kernels_with_tilelibrary.html">Writing High-Performance Kernels with the Tile Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="writint_kernels_with_thread_primitives.html">Annotating Memory Layout for Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="annotate_memory_layout.html">Annotate Memory Layout</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Debugging Tile Language Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto_tuning.html">Auto-Tuning Techniques for Performance Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="jit_compilation.html">Just In Time Compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipelining_computations_and_data_movements.html">Pipelining Computation and Data Movement</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DEEP LEARNING OPERATORS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deeplearning_operators/elementwise.html">ElementWise Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deeplearning_operators/gemv.html">General Matrix-Vector Multiplication (GEMV)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deeplearning_operators/matmul.html">General Matrix-Matrix Multiplication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deeplearning_operators/matmul_dequant.html">General Matrix-Matrix Multiplication with Dequantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deeplearning_operators/flash_attention.html">Flash Attention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deeplearning_operators/flash_linear_attention.html">Flash Linear Attention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deeplearning_operators/convolution.html">Convolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deeplearning_operators/tmac_gpu.html">TMAC: Look Up Table Based Mixed Precision Computing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">LANGUAGE REFERENCE</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../language_ref/ast.html">Tile Language AST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language_ref/primitives.html">Tile Language: Primitives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language_ref/tilelibrary.html">Tile Language: TileLibrary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Privacy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../privacy.html">Privacy</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="debugging-tile-language-programs">
<h1>Debugging Tile Language Programs<a class="headerlink" href="#debugging-tile-language-programs" title="Permalink to this heading">#</a></h1>
<div style="text-align: left;">
    <em>Author:</em> <a href="https://github.com/LeiWang1999">Lei Wang</a>
</div><section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h2>
<p>A Tile Language program (hereafter referred to as a <em>program</em>) is transformed into a hardware-executable file through several stages:</p>
<ol class="arabic simple">
<li><p>The user writes a Tile Language program.</p></li>
<li><p>The program undergoes multiple <em>Passes</em> for transformation and optimization (the <em>lower</em> stage, see <code class="docutils literal notranslate"><span class="pre">tilelang/engine/lower.py</span></code>), finally producing an intermediate representation (e.g., LLVM or C for CPU, CUDA for NVIDIA GPUs, etc.).</p></li>
<li><p>The generated code is compiled by the respective compiler (e.g., nvcc) into a hardware-executable file.</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/overview.png"><img alt="Overview of the compilation process" class="align-center" src="../_images/overview.png" style="width: 300px;" /></a>
<p>During this process, users may encounter roughly three categories of issues:</p>
<ul class="simple">
<li><p><strong>Generation issues</strong>: The Tile Language program fails to generate a valid hardware-executable file (i.e., errors during the lowering process).</p></li>
<li><p><strong>Correctness issues</strong>: The resulting executable runs, but produces incorrect results.</p></li>
<li><p><strong>Performance issues</strong>: The executable runs with performance significantly below the expected theoretical hardware limits.</p></li>
</ul>
<p>This tutorial focuses on the first two issuesâ€”how to debug generation and correctness problems. Performance tuning often requires using vendor-provided profiling tools (e.g., <strong>Nsight Compute</strong>, <strong>rocProf</strong>, etc.) for further hardware-level analysis, which we will address in future materials.</p>
<p>Below, we take matrix multiplication (GEMM) as an example to demonstrate how to write and debug a Tile Language program.</p>
</section>
<section id="matrix-multiplication-example">
<h2>Matrix Multiplication Example<a class="headerlink" href="#matrix-multiplication-example" title="Permalink to this heading">#</a></h2>
<p>In <strong>Tile Language</strong>, you can use the <strong>Tile Library</strong> to implement matrix multiplication. The following is a complete example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tilelang</span>
<span class="kn">import</span> <span class="nn">tilelang.language</span> <span class="k">as</span> <span class="nn">T</span>

<span class="k">def</span> <span class="nf">matmul</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">block_M</span><span class="p">,</span> <span class="n">block_N</span><span class="p">,</span> <span class="n">block_K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float16&quot;</span><span class="p">,</span> <span class="n">accum_dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">):</span>
    <span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
        <span class="n">A</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span> <span class="n">dtype</span><span class="p">),</span>
        <span class="n">B</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">),</span>
        <span class="n">C</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="c1"># Initialize Kernel Context</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ceildiv</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">block_N</span><span class="p">),</span> <span class="n">T</span><span class="o">.</span><span class="n">ceildiv</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">block_M</span><span class="p">),</span> <span class="n">threads</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">):</span>
            <span class="n">A_shared</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_shared</span><span class="p">((</span><span class="n">block_M</span><span class="p">,</span> <span class="n">block_K</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">B_shared</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_shared</span><span class="p">((</span><span class="n">block_K</span><span class="p">,</span> <span class="n">block_N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">C_local</span>  <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_fragment</span><span class="p">((</span><span class="n">block_M</span><span class="p">,</span> <span class="n">block_N</span><span class="p">),</span> <span class="n">accum_dtype</span><span class="p">)</span>

            <span class="n">T</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">C_local</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ko</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">Pipelined</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ceildiv</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">block_K</span><span class="p">),</span> <span class="n">num_stages</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
                <span class="c1"># Copy tile of A</span>
                <span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">by</span> <span class="o">*</span> <span class="n">block_M</span><span class="p">,</span> <span class="n">ko</span> <span class="o">*</span> <span class="n">block_K</span><span class="p">],</span> <span class="n">A_shared</span><span class="p">)</span>

                <span class="c1"># Demonstrate parallelized copy from global to shared for B</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">block_K</span><span class="p">,</span> <span class="n">block_N</span><span class="p">):</span>
                    <span class="n">B_shared</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">ko</span> <span class="o">*</span> <span class="n">block_K</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">bx</span> <span class="o">*</span> <span class="n">block_N</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>

                <span class="c1"># Perform a tile-level GEMM on the shared buffers</span>
                <span class="n">T</span><span class="o">.</span><span class="n">gemm</span><span class="p">(</span><span class="n">A_shared</span><span class="p">,</span> <span class="n">B_shared</span><span class="p">,</span> <span class="n">C_local</span><span class="p">)</span>

            <span class="c1"># Copy result back to global memory</span>
            <span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">C_local</span><span class="p">,</span> <span class="n">C</span><span class="p">[</span><span class="n">by</span> <span class="o">*</span> <span class="n">block_M</span><span class="p">,</span> <span class="n">bx</span> <span class="o">*</span> <span class="n">block_N</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">main</span>

<span class="c1"># 1. Define the kernel (matmul) with the desired dimensions</span>
<span class="n">func</span> <span class="o">=</span> <span class="n">matmul</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

<span class="c1"># 2. Compile the kernel into a torch function</span>
<span class="n">jit_kernel</span> <span class="o">=</span> <span class="n">tilelang</span><span class="o">.</span><span class="n">JITKernel</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">out_idx</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>

<span class="c1"># 3. Test the kernel in Python with PyTorch data</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

<span class="c1"># Run the kernel</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">jit_kernel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="debugging-generation-issues">
<h2>Debugging Generation Issues<a class="headerlink" href="#debugging-generation-issues" title="Permalink to this heading">#</a></h2>
<p>TileLang essentially performs <em>progressive lowering</em>. For example, a <code class="docutils literal notranslate"><span class="pre">T.copy</span></code> may first be expanded into <code class="docutils literal notranslate"><span class="pre">T.Parallel</span></code> (see the pass <code class="docutils literal notranslate"><span class="pre">LowerTileOP</span></code>), which is then expanded again, eventually resulting in lower-level statements that can be translated to CUDA C code.</p>
<a class="reference internal image-reference" href="../_images/ir_transform_diagram.png"><img alt="IR transformation diagram" class="align-center" src="../_images/ir_transform_diagram.png" style="width: 400px;" /></a>
<p>When the code fails to generate (for instance, a compilation error occurs), you do <strong>not</strong> necessarily need to jump directly into C++ passes to debug. Instead, you can first inspect the intermediate representations (IR) in Python by printing them. For example, consider a case where a simple <code class="docutils literal notranslate"><span class="pre">T.copy</span></code> in 1D causes the lowering process to fail. The snippet below illustrates a simplified version of the problem (based on community Issue #35):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">Q</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span><span class="n">shape_q</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)):</span>
    <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ceildiv</span><span class="p">(</span><span class="n">seqlen_q</span><span class="p">,</span> <span class="n">block_M</span><span class="p">),</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">batch</span><span class="p">,</span> <span class="n">num_split</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">):</span>
        <span class="n">Q_shared</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_shared</span><span class="p">([</span><span class="n">block_M</span><span class="p">,</span> <span class="n">dim</span><span class="p">],</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">bid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hid</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Q_shared</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
</pre></div>
</div>
<p>The TileLang lower process might yield an error such as:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>File &quot;/root/TileLang/src/target/codegen_cuda.cc&quot;, line 1257
ValueError: Check failed: lanes &lt;= 4 (8 vs. 4) : Ramp of more than 4 lanes is not allowed.
</pre></div>
</div>
<p>This indicates that somewhere during code generation, an unsupported vectorization pattern was introduced (a ramp of 8 lanes). Before diving into the underlying C++ code, it is helpful to print the IR right before code generation. For instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">device_mod</span> <span class="o">=</span> <span class="n">tir</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="n">is_device_call</span><span class="p">)(</span><span class="n">mod</span><span class="p">)</span>
<span class="n">device_mod</span> <span class="o">=</span> <span class="n">tir</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">LowerDeviceStorageAccessInfo</span><span class="p">()(</span><span class="n">device_mod</span><span class="p">)</span>
<span class="n">device_mod</span> <span class="o">=</span> <span class="n">tir</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">LowerIntrin</span><span class="p">()(</span><span class="n">device_mod</span><span class="p">)</span>
<span class="n">device_mod</span> <span class="o">=</span> <span class="n">tir</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">Simplify</span><span class="p">()(</span><span class="n">device_mod</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">device_mod</span><span class="p">)</span>

<span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
    <span class="n">device_mod</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">_ffi</span><span class="o">.</span><span class="n">get_global_func</span><span class="p">(</span><span class="s2">&quot;target.build.tilelang_cuda&quot;</span><span class="p">)(</span><span class="n">device_mod</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</pre></div>
</div>
<p>By examining the printed IR, you may see how the index calculations expand incorrectly, revealing which pass is handling the special case improperly. You can then fix or refine that pass to address the code generation problem.</p>
</section>
<section id="debugging-correctness-issues">
<h2>Debugging Correctness Issues<a class="headerlink" href="#debugging-correctness-issues" title="Permalink to this heading">#</a></h2>
<p>Sometimes, the kernel compiles and runs but produces incorrect results. In such cases, there are two main strategies to help debug:</p>
<ol class="arabic simple">
<li><p><strong>Use post-processing callbacks to inspect or modify the generated CUDA code.</strong></p></li>
<li><p><strong>Use the built-in ``T.print`` debugging primitive to inspect values at runtime.</strong></p></li>
</ol>
<section id="post-processing-callbacks-for-generated-source">
<h3>Post-Processing Callbacks for Generated Source<a class="headerlink" href="#post-processing-callbacks-for-generated-source" title="Permalink to this heading">#</a></h3>
<p>After code generation (in the codegen pass), TileLang calls a callback function (if registered) to allow post-processing of the generated source code. In <code class="docutils literal notranslate"><span class="pre">src/target/rt_mod_cuda.cc</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cg</span><span class="p">.</span><span class="n">Finish</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Registry</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="s">&quot;tilelang_callback_cuda_postproc&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)(</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">).</span><span class="k">operator</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Hence, by registering a Python function named <code class="docutils literal notranslate"><span class="pre">tilelang_callback_cuda_postproc</span></code>, you can intercept the final CUDA code string. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tilelang</span>
<span class="kn">import</span> <span class="nn">tilelang.language</span> <span class="k">as</span> <span class="nn">T</span>
<span class="kn">from</span> <span class="nn">tilelang</span> <span class="kn">import</span> <span class="n">tvm</span>

<span class="nd">@tvm</span><span class="o">.</span><span class="n">register_func</span>
<span class="k">def</span> <span class="nf">tilelang_callback_cuda_postproc</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="c1"># Example: Insert a comment or print the final CUDA code</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;// Debugging Post-Process</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">code</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">code</span>

<span class="k">def</span> <span class="nf">matmul</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">block_M</span><span class="p">,</span> <span class="n">block_N</span><span class="p">,</span> <span class="n">block_K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float16&quot;</span><span class="p">,</span> <span class="n">accum_dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">):</span>
    <span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span> <span class="n">dtype</span><span class="p">),</span>
             <span class="n">B</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">),</span>
             <span class="n">C</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ceildiv</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">block_N</span><span class="p">),</span> <span class="n">T</span><span class="o">.</span><span class="n">ceildiv</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">block_M</span><span class="p">),</span> <span class="n">threads</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">):</span>
            <span class="n">A_shared</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_shared</span><span class="p">((</span><span class="n">block_M</span><span class="p">,</span> <span class="n">block_K</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">B_shared</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_shared</span><span class="p">((</span><span class="n">block_K</span><span class="p">,</span> <span class="n">block_N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">C_local</span>  <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_fragment</span><span class="p">((</span><span class="n">block_M</span><span class="p">,</span> <span class="n">block_N</span><span class="p">),</span> <span class="n">accum_dtype</span><span class="p">)</span>

            <span class="n">T</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">C_local</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ko</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">Pipelined</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ceildiv</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">block_K</span><span class="p">),</span> <span class="n">num_stages</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">by</span> <span class="o">*</span> <span class="n">block_M</span><span class="p">,</span> <span class="n">ko</span> <span class="o">*</span> <span class="n">block_K</span><span class="p">],</span> <span class="n">A_shared</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">block_K</span><span class="p">,</span> <span class="n">block_N</span><span class="p">):</span>
                    <span class="n">B_shared</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">ko</span> <span class="o">*</span> <span class="n">block_K</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">bx</span> <span class="o">*</span> <span class="n">block_N</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">T</span><span class="o">.</span><span class="n">gemm</span><span class="p">(</span><span class="n">A_shared</span><span class="p">,</span> <span class="n">B_shared</span><span class="p">,</span> <span class="n">C_local</span><span class="p">)</span>
            <span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">C_local</span><span class="p">,</span> <span class="n">C</span><span class="p">[</span><span class="n">by</span> <span class="o">*</span> <span class="n">block_M</span><span class="p">,</span> <span class="n">bx</span> <span class="o">*</span> <span class="n">block_N</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">main</span>

<span class="c1"># Instantiate and compile</span>
<span class="n">func</span> <span class="o">=</span> <span class="n">matmul</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">jit_kernel</span> <span class="o">=</span> <span class="n">tilelang</span><span class="o">.</span><span class="n">JITKernel</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">out_idx</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Using this callback, you can insert debugging statements or simply print out the generated CUDA source to verify the correctness of generated indexing and logic before the kernel is compiled.</p>
</section>
<section id="runtime-debug-prints-with-t-print">
<h3>Runtime Debug Prints with <code class="docutils literal notranslate"><span class="pre">T.print</span></code><a class="headerlink" href="#runtime-debug-prints-with-t-print" title="Permalink to this heading">#</a></h3>
<p>TileLang provides a built-in debugging primitive called <code class="docutils literal notranslate"><span class="pre">T.print</span></code> for printing within kernels. Be mindful of concurrency and thread synchronization when using it in GPU code. Below are some examples showing how to print buffers, variables, and other data inside TileLang programs. These examples can be found in the TileLang codebase (e.g., <code class="docutils literal notranslate"><span class="pre">testing/python/debug/test_tilelang_debug_print.py</span></code>).</p>
<ol class="arabic">
<li><p><strong>Printing an Entire Buffer</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">debug_print_buffer</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;float16&quot;</span>

    <span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
    <span class="k">def</span> <span class="nf">program</span><span class="p">(</span><span class="n">Q</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">):</span>
            <span class="n">shared_buf</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_shared</span><span class="p">([</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="c1"># Print the entire shared_buf</span>
            <span class="n">T</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">shared_buf</span><span class="p">)</span>

    <span class="n">jit_kernel</span> <span class="o">=</span> <span class="n">tilelang</span><span class="o">.</span><span class="n">JITKernel</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="n">profiler</span> <span class="o">=</span> <span class="n">jit_kernel</span><span class="o">.</span><span class="n">get_profiler</span><span class="p">()</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">run_once</span><span class="p">()</span>
</pre></div>
</div>
<p>This will print all elements in <code class="docutils literal notranslate"><span class="pre">shared_buf</span></code> to stdout. Note that in GPU kernels with many threads, outputs can interleave.</p>
</li>
<li><p><strong>Conditional Printing</strong></p>
<p>You can limit print output to reduce noise. For instance, only print when <code class="docutils literal notranslate"><span class="pre">bx</span> <span class="pre">==</span> <span class="pre">0</span> <span class="pre">and</span> <span class="pre">by</span> <span class="pre">==</span> <span class="pre">0</span> <span class="pre">and</span> <span class="pre">bz</span> <span class="pre">==</span> <span class="pre">0</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">debug_print_buffer_conditional</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;float16&quot;</span>

    <span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
    <span class="k">def</span> <span class="nf">program</span><span class="p">(</span><span class="n">Q</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">):</span>
            <span class="n">shared_buf</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_shared</span><span class="p">([</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">by</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">T</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">shared_buf</span><span class="p">)</span>

    <span class="n">jit_kernel</span> <span class="o">=</span> <span class="n">tilelang</span><span class="o">.</span><span class="n">JITKernel</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="n">profiler</span> <span class="o">=</span> <span class="n">jit_kernel</span><span class="o">.</span><span class="n">get_profiler</span><span class="p">()</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">run_once</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><strong>Printing Thread Indices or Scalar Values</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">debug_print_value_conditional</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;float16&quot;</span>

    <span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
    <span class="k">def</span> <span class="nf">program</span><span class="p">(</span><span class="n">Q</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">):</span>
            <span class="c1"># Retrieve thread ID</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">get_thread_binding</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Print bx+by+bz only from one thread</span>
                <span class="n">T</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">bx</span> <span class="o">+</span> <span class="n">by</span> <span class="o">+</span> <span class="n">bz</span><span class="p">)</span>

    <span class="n">jit_kernel</span> <span class="o">=</span> <span class="n">tilelang</span><span class="o">.</span><span class="n">JITKernel</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="n">profiler</span> <span class="o">=</span> <span class="n">jit_kernel</span><span class="o">.</span><span class="n">get_profiler</span><span class="p">()</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">run_once</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><strong>Printing Fragment (Register File) Contents</strong></p>
<p>If you use <code class="docutils literal notranslate"><span class="pre">T.alloc_fragment(...)</span></code> (for example, warp-level matrix fragments), you can still print the data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">debug_print_register_files</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;float16&quot;</span>

    <span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
    <span class="k">def</span> <span class="nf">program</span><span class="p">(</span><span class="n">Q</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">):</span>
            <span class="n">register_buf</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">alloc_fragment</span><span class="p">([</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">],</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="c1"># Parallel iteration with printing</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">T</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
                <span class="n">T</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">register_buf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

    <span class="n">jit_kernel</span> <span class="o">=</span> <span class="n">tilelang</span><span class="o">.</span><span class="n">JITKernel</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="n">profiler</span> <span class="o">=</span> <span class="n">jit_kernel</span><span class="o">.</span><span class="n">get_profiler</span><span class="p">()</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">run_once</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><strong>Adding a Message Prefix</strong></p>
<p>You can supply a message prefix to distinguish prints:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">debug_print_msg</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;float16&quot;</span>

    <span class="nd">@T</span><span class="o">.</span><span class="n">prim_func</span>
    <span class="k">def</span> <span class="nf">program</span><span class="p">(</span><span class="n">Q</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">Buffer</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)):</span>
        <span class="k">with</span> <span class="n">T</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">):</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">get_thread_binding</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">T</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">bx</span> <span class="o">+</span> <span class="n">by</span> <span class="o">+</span> <span class="n">bz</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>

    <span class="n">jit_kernel</span> <span class="o">=</span> <span class="n">tilelang</span><span class="o">.</span><span class="n">JITKernel</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="n">profiler</span> <span class="o">=</span> <span class="n">jit_kernel</span><span class="o">.</span><span class="n">get_profiler</span><span class="p">()</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">run_once</span><span class="p">()</span>
</pre></div>
</div>
<p>The output messages will include something like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>msg=&#39;hello world&#39; BlockIdx=(0, 0, 0), ThreadIdx=(0, 0, 0): 0
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this heading">#</a></h2>
<p>By carefully examining intermediate representations (IR) before final code generationâ€”and by leveraging runtime printing through <code class="docutils literal notranslate"><span class="pre">T.print</span></code>â€”one can quickly diagnose where index calculations, copy logic, or other kernel operations deviate from the intended behavior. This two-pronged approach (inspecting IR transformations and using runtime prints) is often sufficient for resolving generation and correctness issues in TileLang programs.</p>
<p>For advanced performance tuning (e.g., analyzing memory bandwidth or occupancy), more specialized profiling tools such as <strong>Nsight Compute</strong>, <strong>rocProf</strong>, or vendor-specific profilers may be required. Those aspects will be covered in future documents.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="auto_tuning.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Auto-Tuning Techniques for Performance Optimization</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="annotate_memory_layout.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Annotate Memory Layout</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025-2025, Tile Lang Contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Debugging Tile Language Programs</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#matrix-multiplication-example">Matrix Multiplication Example</a></li>
<li><a class="reference internal" href="#debugging-generation-issues">Debugging Generation Issues</a></li>
<li><a class="reference internal" href="#debugging-correctness-issues">Debugging Correctness Issues</a><ul>
<li><a class="reference internal" href="#post-processing-callbacks-for-generated-source">Post-Processing Callbacks for Generated Source</a></li>
<li><a class="reference internal" href="#runtime-debug-prints-with-t-print">Runtime Debug Prints with <code class="docutils literal notranslate"><span class="pre">T.print</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    </body>
</html>